function HIP_CompileVelocityHistogram()% This function was written specifically for processing HIP ATP titration% data. It loads several MAT files with processed Velocity data and% compiles Velocity Histograms.%% USE: Bin = HIP_CompileVelocityHistogram()%% Gheorghe Chistol, 18 Aug 2010%% Ask for the ParametersPrompt = {'Hist Lower Limit (bp/sec)','Hist Upper Lim (bp/sec)',...          'Hist Bin Width (bp/sec)','Length of Packaged DNA(bp)','DNA Length Bin Start (bp)',...          'DNA Length Bin End (bp)','DNA Length Bin Width (bp)'};Title = 'Enter the Following Parameters';Lines = 1;Default = {'-100','50','2','21000','10000','21000','1000'};Options.Resize='on'; Options.WindowStyle='normal'; Options.Interpreter='tex';Answer = inputdlg(Prompt, Title, Lines, Default, Options);%Hist parameters refer to the histogram display at the endHistLowerLim = str2num(Answer{1});HistUpperLim = str2num(Answer{2});HistBinWidth = str2num(Answer{3});LengthDNA    = str2num(Answer{4}); %the length of packaged DNABinStart     = str2num(Answer{5});BinEnd       = str2num(Answer{6});BinWidth     = str2num(Answer{7});%% Declare Global Variables for Folder Namesglobal velocityPath; %declare the folder where MAT files are savedglobal analysisPath;if isempty(velocityPath) && isempty(analysisPath)   velocityPath = uigetdir(pwd , 'Select the Folder with processed velocity MAT files');elseif isempty(velocityPath) && ~isempty(analysisPath)   velocityPath = uigetdir(analysisPath , 'Select the Folder with processed velocity MAT files');elseif velocityPath==0   velocityPath = uigetdir(pwd, 'Select the Folder with processed velocity MAT files');else   velocityPath = uigetdir(velocityPath, 'Select the Folder with processed velocity MAT files');end%Select original files, many files can be selected at once[VelFile] = uigetfile([ [velocityPath '\'] '*.mat'], 'MultiSelect', 'on');Data.Velocity = []; %velocity data pointData.Location = []; %initialize the unified velocity data setData.Force    = []; %average force across that segmentData.Segment  = []; %the length of the corresponding segment used to calculate velocity%process selected files one by oneif ~iscell(VelFile)%if there's only one file    temp=VelFile;    clear VelFile;    VelFile{1}=temp; %make it into a cellend%% Put together all the datafor f=1:length(VelFile) %f stands for File    clear Bins;    load([velocityPath '\' VelFile{f}]);        Data.Velocity = [Data.Velocity Vel.Velocity];    Data.Location = [Data.Location Vel.Location];    Data.Force    = [Data.Force    Vel.Force];    Data.Segment  = [Data.Segment  Vel.Segment];    disp(['Loaded velocity file ' VelFile]);end%% Finally Assemble all the Data in bins temp = BinStart:BinWidth:BinEnd; %make the bins for binning velocity data based on the length of DNA packagedBin.Start = temp(1:end-1); %starting of each binBin.End   = temp(2:end);   %ending of each binBin.Velocity = []; %will add velocity data as we goBin.Location = []; %will add time data as we goBin.Force    = [];Bin.Segment  = [];Data.Location = LengthDNA-Data.Location; %this will be now the length of DNA packaged[Data.Location Index] = sort(Data.Location); %sort location in incresing orderData.Velocity = Data.Velocity(Index);        %order the velocity accordingly Data.Force    = Data.Force(Index);Data.Segment  = Data.Segment(Index);L=length(Bin.Start);for i=1:L    Ind = 1:length(Data.Location); %the indexof all data points    Ind(Data.Location>Bin.End(i))   = []; %remove the points that are outside this bin    Ind(Data.Location<Bin.Start(i)) = [];        Bin.Velocity{i} = Data.Velocity(Ind);    Bin.Location{i} = Data.Location(Ind);    Bin.Force{i}    = Data.Force(Ind);    Bin.Segment{i}  = Data.Segment(Ind);end%% Plot the ResultsHistBins = HistLowerLim:HistBinWidth:HistUpperLim; %x coordinates for the histogram binsL=length(Bin.Start);for i=1:L    figure;    hist(Bin.Velocity{i},HistBins);    MeanVel=mean(Bin.Velocity{i});    StErr  = std(Bin.Velocity{i})/sqrt(length(Bin.Velocity{i}));    title(['DNA packaged:' num2str(Bin.Start(i)) ' to ' num2str(Bin.End(i)) 'bp; Vel=' num2str(MeanVel) '\pm' num2str(StErr)]);    xlabel(['Velocity (bp/sec)']);    ylabel('Occurences');    set(gca,'XLim',[HistLowerLim HistUpperLim]);    set(gca,'YLimMode','auto');end